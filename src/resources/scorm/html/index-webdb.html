<!--
 * This file is part of Totara Mobile
 *
 * Copyright (C) 2019 onwards Totara Learning Solutions LTD
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 *
 * @author: Kamala Tennakoon <kamala.tennakoon@totaralearning.com>
-->

<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- <meta charset="UTF-8" /> -->
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta
      name="author"
      content="Kamala Tennakoon <kamala.tennakoon@totaralearning.com>"
    />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=0.8, minimal-ui"
    />
    <title>Totara Mobile SCORM 1.2</title>
    <!-- <script src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.4.1.min.js"></script> -->
    <!-- <script src="./TotaraMobileScorm.js"></script> -->
    <script type="text/javascript">
      var API = null;

      function LogAPICall() {
        // alert("LogAPICall");
        var data = '';
        for (var i = 0; i < arguments.length; i++) {
          data = data === '' ? arguments[i] : data + ', ' + arguments[i];
        }
        if (document.getElementById('outputContainer')) {
          var loggerWindow = document.getElementById('outputContainer');
          var item = document.createElement('div');
          if (typeof data === 'string') {
            item.innerText = data;
          } else {
            item.innerText = JSON.stringify(data);
          }
          loggerWindow.appendChild(item);
        } else {
          alert(data);
        }
      }
      function commitScormData(scormid, cmid, scoid, attempt, data) {
        // console.log('scormid: ', scormid, 'cmid: ', cmid, 'scoid: ', scoid, 'attempt: ', attempt, 'data: ', data);
        console.log('data:> ', data);
        getScormDataForId(scormid).then(result => {
          let scormData = result;
          let dataDefJson = JSON.parse(scormData.def);
          scormData.scoid = scoid;
          scormData.cmid = cmid;
          scormData.attempt = attempt;
          let updatedScoDef = dataDefJson[scoid];
          console.log("\nexist data:> ",updatedScoDef);
          if (updatedScoDef) {
            updatedScoDef = {...updatedScoDef, ...data};
          } else {
            updatedScoDef = data;
          }
          console.log("\nupdated data:> ",updatedScoDef);
          dataDefJson[scoid] = updatedScoDef;
          scormData.def = JSON.stringify(dataDefJson);
          setScormForId(scormData, scormid)
        });
      }

      const tmpdef = {
        '12': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '13': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'resume',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00.00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': 'passed',
          'cmi.core.score.raw': '1',
          'cmi.core.score.max': '10',
          'cmi.core.score.min': '0',
          'cmi.core.exit': 'suspend',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '14': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': '',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': 'qii',
          'cmi.core.lesson_status': 'passed',
          'cmi.core.score.raw': '8',
          'cmi.core.score.max': '10',
          'cmi.core.score.min': '0',
          'cmi.core.exit': '',
          'cmi.suspend_data': 's',
          'cmi.comments': 'lmi',
          'cmi.student_preference.language': 'en',
          'cmi.student_preference.audio': '7',
          'cmi.student_preference.speed': '4',
          'cmi.student_preference.text': '0',
        },
        '15': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': '',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': 'completed',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '16': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '17': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '18': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '19': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
        '20': {
          'cmi.core.student_id': 'kamala',
          'cmi.core.student_name': 'Tennakoon, Kamala',
          'cmi.core.credit': 'credit',
          'cmi.core.entry': 'ab-initio',
          'cmi.core.lesson_mode': 'normal',
          'cmi.launch_data': '',
          'cmi.student_data.mastery_score': '',
          'cmi.student_data.max_time_allowed': '',
          'cmi.student_data.time_limit_action': '',
          'cmi.core.total_time': '00:00:00',
          'cmi.core.lesson_location': '',
          'cmi.core.lesson_status': '',
          'cmi.core.score.raw': '',
          'cmi.core.score.max': '',
          'cmi.core.score.min': '',
          'cmi.core.exit': '',
          'cmi.suspend_data': '',
          'cmi.comments': '',
          'cmi.student_preference.language': '',
          'cmi.student_preference.audio': '0',
          'cmi.student_preference.speed': '0',
          'cmi.student_preference.text': '0',
        },
      };
      const tmpcmiobj = {
        '12': '',
        '13': '',
        '14': '',
        '15': '',
        '16': '',
        '17': '',
        '18': '',
        '19': '',
        '20': '',
      };
      const tmpcmiint = {
        '12': '',
        '13': '',
        '14': '',
        '15': '',
        '16': '',
        '17': '',
        '18': '',
        '19': '',
        '20': '',
      };
      const tmpcmistring256 = '^[\\u0000-\\uFFFF]{0,255}$'; // NO
      const tmpcmistring4096 = '^[\\u0000-\\uFFFF]{0,4096}$'; // NO
      const tmpscormdebugging = false;
      const tmpscormauto = '0';
      const tmpscormid = '6';
      const tmpscoid = '16';
      const tmpcfgwwwroot = 'file://Web.bundle'; // NO
      const tmpsesskey = '2FyAQHjuTQ'; //NO
      const tmpselectedscoid = '16'; //--Need to pass from event
      const tmpattempt = '1'; //--Need to pass from event
      const tmpviewmode = 'normal'; //--Need to pass from event
      const tmpcmid = 8;
      const tmpcurrentorg = 'mm-SCORMDEbugger555f231e21b982c25d16'; //--Need to pass from event
      const tmpautocommit = false;
      const tmpmasteryoverride = true;
      const tmphidetoc = '0';
    </script>
  </head>

  <body style="margin: 0; padding: 0;height: 100%;" >
    <h3 style="background: rgb(177, 174, 174)">Totara Mobile SCORM 1.2</h3>
    <div id="scorm_object_container" style="height: 520px; width: 100%; background: rgb(214, 238, 240); overflow: scroll; display: block;" >
    <iframe
        id="scorm_object"
        allowfullscreen="allowfullscreen"
        webkitallowfullscreen="webkitallowfullscreen"
        mozallowfullscreen="mozallowfullscreen"
        height="500"
        width="100%"
        src="loading_scorm.html"
      >
      </iframe>
    </div>
    <p>
    <button type="button"  onclick="document.getElementById('outputContainer').innerHTML='';">Clear Log</button>
    <button type="button" onclick="loadScromPackageForId('6');">Load scorm data</button>
    <button type="button" onclick="resetScormDataForPackage();">Reset scorm data</button>
  </p>
    <div id="outputContainer" style="width: 100%; background: #cecece; height: 200px; overflow: scroll;"></div>

    <script type="text/javascript">
      // In the following line, you should include the prefixes of implementations you want to test.
      window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
      // DON'T use "var indexedDB = ..." if you're not in a function.
      // Moreover, you may need references to some window.IDB* objects:
      window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: 'readwrite'}; // This line should only be needed if it is needed to support the object's constants for older browsers
      window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
      // (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)
      if (!window.indexedDB) {
        window.alert("Your browser doesn't support for IndexedDB. Such and such feature will not be available.");
      }
      var db;
      // Let us open our database
      var request = window.indexedDB.open('TotaraMobileScorm', 1);

      request.onerror = function(event) {
        window.alert('Not allowed to use IndexedDB.');
      };
      request.onsuccess = function(event) {
        // Do something with request.result!
        db = event.target.result;
      };

      var scormData = {
        def: JSON.stringify(tmpdef),
        cmiobj: JSON.stringify(tmpcmiobj),
        cmiint: JSON.stringify(tmpcmiint),
        cmistring256: tmpcmistring256,
        cmistring4096: tmpcmistring4096,
        scormdebugging: tmpscormdebugging,
        scormauto: tmpscormauto,
        scormid: tmpscormid,
        cfgwwwroot: tmpcfgwwwroot,
        sesskey: tmpsesskey,
        scoid: tmpscoid,
        attempt: tmpattempt,
        viewmode: tmpviewmode,
        cmid: tmpcmid,
        currentorg: tmpcurrentorg,
        autocommit: tmpautocommit,
        masteryoverride: tmpmasteryoverride,
        hidetoc: tmphidetoc,
      };
      
      request.onupgradeneeded = function(event) {
        var db = event.target.result;
        var objectStore = db.createObjectStore('scorm_package', {
          keyPath: 'scormid',
        });
        objectStore.add(scormData);
      };
      
      function getScormDataForId(id) {
        let promise = new Promise(function(resolve, reject) {
          var transaction = db.transaction(['scorm_package']);
          var objectStore = transaction.objectStore('scorm_package');

          var request = objectStore.get(id);
          request.onerror = function(event) {
            reject(new Error('Unable to retrieve data from database'));
          };
          request.onsuccess = function(event) {
            // Do something with the request.result!
            if (request.result) {
              resolve(request.result);
            } else {
              reject(new Error("Data couldn't be found"));
            }
          };
        });
        return promise;
      }
      
      function resetScormDataForPackage() {
        var request = db
          .transaction(['scorm_package'], 'readwrite')
          .objectStore('scorm_package')
          .put(scormData);

        request.onsuccess = function(event) {
          console.log('Data added successfully.');
        };

        request.onerror = function(event) {
          alert('Unable to add to database!');
        };
      }
      
      function setScormForId(data,id) {
        var request = db
          .transaction(['scorm_package'], 'readwrite')
          .objectStore('scorm_package')
          .put(data);

        request.onsuccess = function(event) {
          console.log('Data added successfully.');
        };

        request.onerror = function(event) {
          alert('Unable to add to database!');
        };
      }
      
      function addScormDataForPackage() {
        var request = db
          .transaction(['scorm_package'], 'readwrite')
          .objectStore('scorm_package')
          .add(scormData);

        request.onsuccess = function(event) {
          console.log('Data added successfully.');
        };

        request.onerror = function(event) {
          alert('Unable to add to database!');
        };
      }
      
      function loadScromPackageForId(id) {
        getScormDataForId(id).then(data => {
          console.log(data);
          API = new SCORMapi1_2(
            JSON.parse(data.def),
            JSON.parse(data.cmiobj),
            JSON.parse(data.cmiint),
            data.cmistring256,
            data.cmistring4096,
            data.scormdebugging,
            data.scormauto,
            data.scormid,
            data.cfgwwwroot,
            data.sesskey,
            data.scoid,
            data.attempt,
            data.viewmode,
            data.cmid,
            data.currentorg,
            data.autocommit,
            data.masteryoverride,
            data.hidetoc,
          );
          // alert('Need to set iframe');
          // document.getElementById('scorm_object').contentWindow.location = './complexscorm/index.html';
          document.getElementById('scorm_object').setAttribute('src', './complexscorm/index.html');
          // document.getElementById('scorm_object').setAttribute('src', 'Web.bundle/complexscorm/index.html');
          // document.getElementById('scorm_object_container').innerHTML = '<iFrame id="scorm_object" height="500" type="text/html" src="./complexscorm/index.html"></iFrame>';
        });
      }
    </script>
    <script src="scorm_12.js"></script>
  </body>
</html>
